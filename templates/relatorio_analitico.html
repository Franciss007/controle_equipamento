{% extends "base.html" %}
{% block title %}Analítico{% endblock %}
{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='relatorio.css') }}">
{% endblock %}
{% block content %}
<h1>Relatórios Analítico de Solicitações</h1>
{% if solicitacoes %}
<div class="filtros-wrapper">
    <div class="filtro-container">
        <label for="filtro-filial">Filtrar por Filial:</label>
        <input type="text" id="filtro-filial" placeholder="Digite a filial...">
    </div>
    <div class="filtro-container">
        <label for="filtro-setor">Filtrar por Setor:</label>
        <input type="text" id="filtro-setor" placeholder="Digite o setor...">
    </div>
    <div class="filtro-container">
        <label for="filtro-tipo">Filtrar por Tipo:</label>
        <input type="text" id="filtro-tipo" placeholder="Digite o tipo...">
    </div>
    <div class="filtro-container">
        <button id="exportar">Exportar tabela</button>
    </div>
</div>
    
    
    <table id="tabela-equipamentos" class="tabela">
        <thead>
            <tr>
                <th>Protocolo</th><th>Solicitante</th><th>Filial</th><th class="col-oculta">Setor</th><th class="col-oculta">Prioridade</th><th>Status</th><th class="col-oculta">Tipo</th><th class="col-oculta">Aberta em</th><th class="col-oculta">Descrição</th><th class="mobile-col">Detalhes</th>
            </tr>
        </thead>
        <tbody>
            {% for s in solicitacoes %}
            <tr>
                <td>{{ s.id }}</td>
                <td>{{ s.solicitante_nome }}</td>
                <td>{{ s.filial }}</td>
                <td class="col-oculta">{{ s.setor }}</td>
                <td class="col-oculta">{{ s.prioridade }}</td>
                <td>{{ s.status }}</td>
                <td class="col-oculta">{{ s.tipo }}</td>
                <td class="col-oculta">{{ s.data_abertura }}</td>
                <td class="col-oculta">
                    <a href="{{ url_for('ver_descricao', id=s.id) }}" class="btn">Ver descrição</a>
                </td>
                <td class="mobile-col">
                    <a href="{{ url_for('ver_descricao', id=s.id) }}" class="btn">Ver mais</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Sem dados para exibir.</p>
{% endif %}

<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script>
    const filtroFilial = document.getElementById("filtro-filial");
    const filtroSetor = document.getElementById("filtro-setor");
    const filtroTipo = document.getElementById("filtro-tipo");
    const tabela = document.querySelector('#tabela-equipamentos tbody');

    function filtrarTabela() {
        const filialValor = filtroFilial.value.toLowerCase();
        const setorValor = filtroSetor.value.toLowerCase();
        const tipoValor = filtroTipo.value.toLowerCase();

        Array.from(tabela.rows).forEach(row => {
            const filial = row.cells[2].textContent.toLowerCase();
            const setor = row.cells[3].textContent.toLowerCase();
            const tipo = row.cells[6].textContent.toLowerCase();

            row.style.display = (filial.includes(filialValor) &&
                                 setor.includes(setorValor) &&
                                 tipo.includes(tipoValor)) ? '' : 'none';
        });
    }

    if (tabela) {
        filtroFilial.addEventListener("input", filtrarTabela);
        filtroSetor.addEventListener("input", filtrarTabela);
        filtroTipo.addEventListener("input", filtrarTabela);
    }

    document.getElementById('exportar').addEventListener('click', () => {
    const wb = XLSX.utils.book_new();
    const tabelaVisivel = document.getElementById('tabela-equipamentos');
    const ws = XLSX.utils.table_to_sheet(tabelaVisivel, {raw: true});
    XLSX.utils.book_append_sheet(wb, ws, "Sintético");
    XLSX.writeFile(wb, "relatorio_analitico.xlsx");
})
</script>
{% endblock %}
